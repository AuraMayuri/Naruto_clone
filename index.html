<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Real Ninja Split</title>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js"></script>

<style>
body{margin:0;overflow:hidden;background:black;}
video,canvas{
  position:absolute;
  width:100vw;
  height:100vh;
  object-fit:cover;
}
</style>
</head>

<body>

<video id="video" autoplay playsinline></video>
<canvas id="canvas"></canvas>

<script>

const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

let mode = "idle"; 
// idle → smoke → split → cooldown

let smoke = [];
let splitTimer = 0;
let cooldownTimer = 0;

// เปิดกล้อง
navigator.mediaDevices.getUserMedia({video:true})
.then(stream=>video.srcObject=stream);

// ===== Hands =====
const hands = new Hands({
  locateFile:(file)=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
});
hands.setOptions({
  maxNumHands:2,
  modelComplexity:0,
  minDetectionConfidence:0.7,
  minTrackingConfidence:0.7
});

// ===== Segmentation =====
const segmenter = new SelfieSegmentation({
  locateFile:(file)=>`https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${file}`
});
segmenter.setOptions({modelSelection:1});

// ===== ตรวจ gesture =====
hands.onResults(res=>{
  if(mode !== "idle") return;

  if(res.multiHandLandmarks &&
     res.multiHandLandmarks.length===2){

    const h1=res.multiHandLandmarks[0][8];
    const h2=res.multiHandLandmarks[1][8];

    const dx=h1.x-h2.x;
    const dy=h1.y-h2.y;
    const dist=Math.sqrt(dx*dx+dy*dy);

    if(dist < 0.05){
      triggerSmoke();
    }
  }
});

function triggerSmoke(){
  mode="smoke";

  for(let i=0;i<30;i++){
    smoke.push({
      x:canvas.width/2,
      y:canvas.height/2,
      size:20+Math.random()*30,
      alpha:1,
      vx:(Math.random()-0.5)*5,
      vy:(Math.random()-0.5)*5
    });
  }

  setTimeout(()=>{
    mode="split";
    splitTimer=90;
  },700);
}

// ===== segmentation loop =====
segmenter.onResults(results=>{

  ctx.clearRect(0,0,canvas.width,canvas.height);

  // พื้นหลังปกติ
  ctx.drawImage(video,0,0,canvas.width,canvas.height);

  if(mode==="split"){

    ctx.save();

    // ใช้ mask ตัดตัวคน
    ctx.drawImage(results.segmentationMask,
      0,0,canvas.width,canvas.height);

    ctx.globalCompositeOperation="source-in";

    // วาด 10 ร่าง
    for(let i=1;i<=5;i++){
      ctx.globalAlpha=0.4;
      ctx.drawImage(video,-40*i,0,
        canvas.width,canvas.height);
      ctx.drawImage(video,40*i,0,
        canvas.width,canvas.height);
    }

    ctx.restore();
    ctx.globalAlpha=1;

    splitTimer--;
    if(splitTimer<=0){
      mode="cooldown";
      cooldownTimer=60;
    }
  }

  updateSmoke();
  drawSmoke();

  if(mode==="cooldown"){
    cooldownTimer--;
    if(cooldownTimer<=0){
      mode="idle";
    }
  }
});

// ===== ควัน =====
function updateSmoke(){
  for(let i=smoke.length-1;i>=0;i--){
    let p=smoke[i];
    p.x+=p.vx;
    p.y+=p.vy;
    p.alpha-=0.04;
    if(p.alpha<=0) smoke.splice(i,1);
  }
}

function drawSmoke(){
  for(let p of smoke){
    ctx.beginPath();
    ctx.arc(p.x,p.y,p.size,0,Math.PI*2);
    ctx.fillStyle="rgba(200,200,200,"+p.alpha+")";
    ctx.fill();
  }
}

// loop
function loop(){
  hands.send({image:video});
  segmenter.send({image:video});
  requestAnimationFrame(loop);
}

video.addEventListener("loadeddata",()=>{
  loop();
});

</script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Smoke Poof Effect</title>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

<style>
body{
  margin:0;
  overflow:hidden;
  background:black;
}
video{
  position:absolute;
  width:100vw;
  height:100vh;
  object-fit:cover;
}
canvas{
  position:absolute;
  width:100vw;
  height:100vh;
}
</style>
</head>

<body>

<video id="video" autoplay playsinline></video>
<canvas id="canvas"></canvas>

<script>

const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

let lastProcessTime = 0;
const PROCESS_INTERVAL = 250;

let smokeBursts = [];

// à¹€à¸›à¸´à¸”à¸à¸¥à¹‰à¸­à¸‡
async function initCamera(){
  const stream = await navigator.mediaDevices.getUserMedia({
    video:{ width:640, height:480, frameRate:24 }
  });
  video.srcObject = stream;
}
initCamera();

const hands = new Hands({
  locateFile:(file)=>{
    return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
  }
});

hands.setOptions({
  maxNumHands:2,
  modelComplexity:0,
  minDetectionConfidence:0.7,
  minTrackingConfidence:0.7
});

// ðŸ”¥ à¸ªà¸£à¹‰à¸²à¸‡à¸„à¸§à¸±à¸™à¸£à¸°à¹€à¸šà¸´à¸”
function createSmokeBurst(x,y){
  smokeBursts.push({
    x:x,
    y:y,
    size:0,
    alpha:1
  });
}

// ðŸ”¥ à¸§à¸²à¸”à¸„à¸§à¸±à¸™à¸£à¸°à¹€à¸šà¸´à¸”
function drawSmokeBursts(){
  for(let i=smokeBursts.length-1;i>=0;i--){
    let s = smokeBursts[i];

    s.size += 8;      // à¸‚à¸¢à¸²à¸¢à¹€à¸£à¹‡à¸§
    s.alpha -= 0.05;  // à¸ˆà¸²à¸‡à¸¥à¸‡

    ctx.beginPath();
    ctx.arc(s.x,s.y,s.size,0,Math.PI*2);
    ctx.fillStyle = "rgba(220,220,220,"+s.alpha+")";
    ctx.fill();

    if(s.alpha <= 0){
      smokeBursts.splice(i,1);
    }
  }
}

hands.onResults(results=>{

  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(video,0,0,canvas.width,canvas.height);

  let distanceText="Waiting...";

  if(results.multiHandLandmarks &&
     results.multiHandLandmarks.length===2){

    const hand1 = results.multiHandLandmarks[0];
    const hand2 = results.multiHandLandmarks[1];

    const p1 = hand1[8];
    const p2 = hand2[8];

    const dx = p1.x - p2.x;
    const dy = p1.y - p2.y;
    const distance = Math.sqrt(dx*dx + dy*dy);

    distanceText="Distance: "+distance.toFixed(3);

    for(const landmarks of results.multiHandLandmarks){
      drawConnectors(ctx,landmarks,HAND_CONNECTIONS,
        {color:"lime",lineWidth:2});
      drawLandmarks(ctx,landmarks,
        {color:"red",lineWidth:1});
    }

    if(distance < 0.06){
      createSmokeBurst(canvas.width/2, canvas.height/2);
    }
  }

  ctx.fillStyle="white";
  ctx.font="24px Arial";
  ctx.fillText(distanceText,20,40);

  drawSmokeBursts();

});

// loop à¸«à¸™à¹ˆà¸§à¸‡à¹€à¸§à¸¥à¸²
function detectLoop(){
  const now = Date.now();
  if(now - lastProcessTime > PROCESS_INTERVAL){
    hands.send({image:video});
    lastProcessTime = now;
  }
  requestAnimationFrame(detectLoop);
}

video.addEventListener("loadeddata",()=>{
  detectLoop();
});

</script>

</body>
</html>

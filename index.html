<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Ninja Clone Safari Fix</title>
<style>
body{margin:0;overflow:hidden;background:black;}
video{display:none;}
canvas{position:absolute;top:0;left:0;}
#startBtn{
  position:absolute;
  top:40%;
  left:50%;
  transform:translate(-50%,-50%);
  padding:20px 40px;
  font-size:22px;
  z-index:10;
}
</style>
</head>
<body>

<button id="startBtn">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏≤‡∏ñ‡∏≤</button>

<video id="video" playsinline muted></video>
<canvas id="canvas"></canvas>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const btn = document.getElementById("startBtn");

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

btn.onclick = async () => {

  btn.style.display="none";

  const stream = await navigator.mediaDevices.getUserMedia({
    video:{ facingMode:"user" }
  });

  video.srcObject = stream;

  await video.play();

  const hands = new Hands({
    locateFile: file =>
      `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
  });

  // üî• ‡∏õ‡∏¥‡∏î GPU ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤ iPad
  hands.setOptions({
    maxNumHands:2,
    modelComplexity:0,
    minDetectionConfidence:0.6,
    minTrackingConfidence:0.6
  });

  // hands.onResults(results=>{

  //   ctx.clearRect(0,0,canvas.width,canvas.height);

  //   ctx.drawImage(video,0,0,
  //     canvas.width,canvas.height);

  //   if(results.multiHandLandmarks){
  //     for(const landmarks of results.multiHandLandmarks){
  //       drawConnectors(ctx,landmarks,HAND_CONNECTIONS,
  //         {color:"lime",lineWidth:3});
  //       drawLandmarks(ctx,landmarks,
  //         {color:"red",lineWidth:2});
  //     }
  //   }
  // });
  let holdStart = 0;
let isCloning = false;
let clones = [];
  let debugText = "";
//   let cloneCount = 0;
// let holdStart = 0;

let showCartoon = false;
  
  
hands.onResults(results => {

  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(video,0,0,canvas.width,canvas.height);

  if(results.multiHandLandmarks &&
     results.multiHandLandmarks.length === 2){

    const hand1 = results.multiHandLandmarks[0];
    const hand2 = results.multiHandLandmarks[1];

    // ‡πÉ‡∏ä‡πâ‡∏à‡∏∏‡∏î‡∏Å‡∏•‡∏≤‡∏á‡∏ù‡πà‡∏≤‡∏°‡∏∑‡∏≠ (landmark 9)
    const p1 = hand1[9];
    const p2 = hand2[9];

    const dx = p1.x - p2.x;
    const dy = p1.y - p2.y;
    const distance = Math.sqrt(dx*dx + dy*dy);

    // ‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÅ‡∏î‡∏á
    for(const landmarks of results.multiHandLandmarks){
      drawConnectors(ctx,landmarks,HAND_CONNECTIONS,
        {color:"lime",lineWidth:2});
      drawLandmarks(ctx,landmarks,
        {color:"red",lineWidth:1});
    }

    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏∑‡∏≠‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡πÉ‡∏Å‡∏•‡πâ‡∏Å‡∏±‡∏ô
    if(distance < 0.08){
      showCartoon = true;
    } else {
      showCartoon = false;
    }
  } else {
    showCartoon = false;
  }

  // üî• ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤
  if(showCartoon){
  drawCartoon(canvas.width - 100,100);
}
ctx.fillStyle="white";
ctx.fillText("dist: "+distance.toFixed(3),20,40);

});

  
function drawCartoon(x,y){

  ctx.beginPath();
  ctx.arc(x,y,60,0,Math.PI*2);
  ctx.fillStyle="yellow";
  ctx.fill();

  // ‡∏ï‡∏≤
  ctx.beginPath();
  ctx.arc(x-20,y-15,8,0,Math.PI*2);
  ctx.arc(x+20,y-15,8,0,Math.PI*2);
  ctx.fillStyle="black";
  ctx.fill();

  // ‡∏õ‡∏≤‡∏Å
  ctx.beginPath();
  ctx.arc(x,y+10,25,0,Math.PI);
  ctx.strokeStyle="black";
  ctx.lineWidth=3;
  ctx.stroke();
}
  
  


//   function createClone(){

//   // ‡πÅ‡∏Ñ‡∏õ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å canvas ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡πÄ‡∏ö‡∏≤‡∏Å‡∏ß‡πà‡∏≤)
//   const img = new Image();
//   img.src = canvas.toDataURL("image/jpeg", 0.6);

//   img.onload = () => {
//     clones.push(img);
//   };

//   // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏£‡πà‡∏≤‡∏á‡πÄ‡∏¢‡∏≠‡∏∞‡πÄ‡∏Å‡∏¥‡∏ô
//   if(clones.length > 3){
//     clones.shift();
//   }

//   // ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Ñ‡πÅ‡∏ü‡∏•‡∏ä
//   flash.style.opacity = 1;
//   setTimeout(()=>flash.style.opacity=0,150);

//   // ‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡∏Å‡∏±‡∏ô error)
//   try{
//     const audio = new Audio(
//       "https://actions.google.com/sounds/v1/cartoon/poof.ogg"
//     );
//     audio.play();
//   }catch(e){}
// }
 

  async function detectLoop(){
    await hands.send({image:video});
    requestAnimationFrame(detectLoop);
  }

  detectLoop();
};
</script>

</body>
</html>

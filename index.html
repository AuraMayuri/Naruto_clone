<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Stable Freeze Split</title>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js"></script>

<style>
body{margin:0;overflow:hidden;background:black;}
video,canvas{
  position:absolute;
  width:100vw;
  height:100vh;
  object-fit:cover;
}
#log{
  position:absolute;
  top:10px;
  left:10px;
  color:#00ff88;
  background:rgba(0,0,0,0.6);
  padding:8px;
  font-size:14px;
}
</style>
</head>
<body>

<video id="video" autoplay playsinline></video>

<canvas id="bgCanvas"></canvas>
<canvas id="mainCanvas"></canvas>
<canvas id="fxCanvas"></canvas>

<div id="log"></div>

<script>

const video=document.getElementById("video");
const bgCanvas=document.getElementById("bgCanvas");
const mainCanvas=document.getElementById("mainCanvas");
const fxCanvas=document.getElementById("fxCanvas");

const bgCtx=bgCanvas.getContext("2d");
const mainCtx=mainCanvas.getContext("2d");
const fxCtx=fxCanvas.getContext("2d");

const logDiv=document.getElementById("log");

[bgCanvas,mainCanvas,fxCanvas].forEach(c=>{
  c.width=window.innerWidth;
  c.height=window.innerHeight;
});

let mode="idle";
let distanceLog=0;
let splitTimer=0;
let personImage=null;
let smoke=[];

// กล้อง
navigator.mediaDevices.getUserMedia({video:true})
.then(s=>video.srcObject=s);

// ===== Hands =====
const hands=new Hands({
 locateFile:(f)=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
});
hands.setOptions({
 maxNumHands:2,
 modelComplexity:0,
 minDetectionConfidence:0.7,
 minTrackingConfidence:0.7
});

hands.onResults(res=>{

 if(mode==="idle"){
   mainCtx.clearRect(0,0,mainCanvas.width,mainCanvas.height);
   mainCtx.drawImage(video,0,0,mainCanvas.width,mainCanvas.height);
 }

 if(res.multiHandLandmarks){
   for(const landmarks of res.multiHandLandmarks){
     drawConnectors(mainCtx,landmarks,HAND_CONNECTIONS,
       {color:"#00FF00",lineWidth:3});
     drawLandmarks(mainCtx,landmarks,
       {color:"#FF0000",lineWidth:2});
   }

   if(res.multiHandLandmarks.length===2 && mode==="idle"){
     const h1=res.multiHandLandmarks[0][8];
     const h2=res.multiHandLandmarks[1][8];
     const dx=h1.x-h2.x;
     const dy=h1.y-h2.y;
     distanceLog=Math.sqrt(dx*dx+dy*dy);

     if(distanceLog<0.05){
       triggerEffect();
     }
   }
 }

 updateLog();
});

// ===== Segmentation =====
const segmenter=new SelfieSegmentation({
 locateFile:(f)=>`https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${f}`
});
segmenter.setOptions({modelSelection:1});

segmenter.onResults(results=>{

 if(mode!=="capture") return;

 // freeze background
 bgCtx.drawImage(video,0,0,bgCanvas.width,bgCanvas.height);

 // extract person
 const temp=document.createElement("canvas");
 temp.width=bgCanvas.width;
 temp.height=bgCanvas.height;
 const t=temp.getContext("2d");

 t.drawImage(results.segmentationMask,0,0,temp.width,temp.height);
 t.globalCompositeOperation="source-in";
 t.drawImage(video,0,0,temp.width,temp.height);

 personImage=temp;

 mode="split";
 splitTimer=120;
});

// ===== เอฟเฟกต์ =====
function triggerEffect(){

 mode="capture";

 // ควัน 1 ครั้ง
 for(let i=0;i<30;i++){
   smoke.push({
     x:fxCanvas.width/2,
     y:fxCanvas.height/2,
     size:20+Math.random()*30,
     alpha:1,
     vx:(Math.random()-0.5)*5,
     vy:(Math.random()-0.5)*5
   });
 }

 // เรียก segmentation หลังควัน
 setTimeout(()=>{
   segmenter.send({image:video});
 },600);
}

// ===== loop วาด split + smoke =====
function drawFX(){

 fxCtx.clearRect(0,0,fxCanvas.width,fxCanvas.height);

 // ควัน
 for(let i=smoke.length-1;i>=0;i--){
   let p=smoke[i];
   p.x+=p.vx;
   p.y+=p.vy;
   p.alpha-=0.03;

   fxCtx.beginPath();
   fxCtx.arc(p.x,p.y,p.size,0,Math.PI*2);
   fxCtx.fillStyle="rgba(200,200,200,"+p.alpha+")";
   fxCtx.fill();

   if(p.alpha<=0) smoke.splice(i,1);
 }

 // split
 if(mode==="split" && personImage){
   mainCtx.clearRect(0,0,mainCanvas.width,mainCanvas.height);

   // วาดพื้นหลังนิ่ง
   mainCtx.drawImage(bgCanvas,0,0);

   // แยกเฉพาะคน
   for(let i=1;i<=5;i++){
     mainCtx.globalAlpha=0.4;
     mainCtx.drawImage(personImage,-40*i,0,
       mainCanvas.width,mainCanvas.height);
     mainCtx.drawImage(personImage,40*i,0,
       mainCanvas.width,mainCanvas.height);
   }

   mainCtx.globalAlpha=1;

   splitTimer--;
   if(splitTimer<=0){
     mode="idle";
     personImage=null;
   }
 }

 requestAnimationFrame(drawFX);
}
drawFX();

function updateLog(){
 logDiv.innerHTML=
 "MODE: "+mode+"<br>"+
 "DISTANCE: "+distanceLog.toFixed(4)+"<br>"+
 "SPLIT TIMER: "+splitTimer+"<br>"+
 "Smoke: "+smoke.length;
}

function loop(){
 hands.send({image:video});
 requestAnimationFrame(loop);
}
video.addEventListener("loadeddata",loop);

</script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Advanced Split</title>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

<style>
body{margin:0;overflow:hidden;background:black;}
video,canvas{
  position:absolute;
  width:100vw;
  height:100vh;
  object-fit:cover;
}
</style>
</head>

<body>

<video id="video" autoplay playsinline></video>
<canvas id="canvas"></canvas>

<script>

const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

let PROCESS_INTERVAL = 250;
let lastProcessTime = 0;

let smoke = [];
let splitActive = false;
let splitTimer = 0;

let backgroundImage = null;
let effectCooldown = false;

// ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
async function initCamera(){
  const stream = await navigator.mediaDevices.getUserMedia({
    video:{ width:640,height:480,frameRate:24 }
  });
  video.srcObject = stream;
}
initCamera();

// MediaPipe
const hands = new Hands({
  locateFile:(file)=>{
    return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
  }
});

hands.setOptions({
  maxNumHands:2,
  modelComplexity:0,
  minDetectionConfidence:0.7,
  minTrackingConfidence:0.7
});

// ===== ‡∏Ñ‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß =====
function createSmokeBurst(x,y){
  for(let i=0;i<20;i++){
    smoke.push({
      x:x,
      y:y,
      size:20+Math.random()*30,
      alpha:1,
      vx:(Math.random()-0.5)*3,
      vy:(Math.random()-0.5)*3
    });
  }
}

function updateSmoke(){
  for(let i=smoke.length-1;i>=0;i--){
    let s=smoke[i];
    s.x+=s.vx;
    s.y+=s.vy;
    s.alpha-=0.04;
    if(s.alpha<=0){
      smoke.splice(i,1);
    }
  }
}

function drawSmoke(){
  for(let s of smoke){
    ctx.beginPath();
    ctx.arc(s.x,s.y,s.size,0,Math.PI*2);
    ctx.fillStyle="rgba(200,200,200,"+s.alpha+")";
    ctx.fill();
  }
}

// ===== ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö =====
hands.onResults(results=>{

  ctx.clearRect(0,0,canvas.width,canvas.height);

  if(splitActive && backgroundImage){
    ctx.drawImage(backgroundImage,0,0,
      canvas.width,canvas.height);
  }else{
    ctx.drawImage(video,0,0,
      canvas.width,canvas.height);
  }

  // ===== ‡πÅ‡∏¢‡∏Å‡∏£‡πà‡∏≤‡∏á 10 ‡∏£‡πà‡∏≤‡∏á =====
  if(splitActive){

    for(let i=1;i<=5;i++){

      ctx.globalAlpha=0.4;
      ctx.drawImage(video,-40*i,-20*i,
        canvas.width,canvas.height);

      ctx.globalAlpha=0.4;
      ctx.drawImage(video,40*i,-20*i,
        canvas.width,canvas.height);
    }

    ctx.globalAlpha=1;

    splitTimer--;
    if(splitTimer<=0){
      splitActive=false;
      backgroundImage=null;
    }
  }

  if(results.multiHandLandmarks &&
     results.multiHandLandmarks.length===2 &&
     !effectCooldown){

    const h1=results.multiHandLandmarks[0];
    const h2=results.multiHandLandmarks[1];

    const p1=h1[8];
    const p2=h2[8];

    const dx=p1.x-p2.x;
    const dy=p1.y-p2.y;
    const dist=Math.sqrt(dx*dx+dy*dy);

    if(dist<0.06){

      effectCooldown=true;

      // üì∏ ‡πÄ‡∏Å‡πá‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
      backgroundImage=document.createElement("canvas");
      backgroundImage.width=canvas.width;
      backgroundImage.height=canvas.height;
      backgroundImage
        .getContext("2d")
        .drawImage(video,0,0,
          canvas.width,canvas.height);

      // üå´ ‡∏Ñ‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
      createSmokeBurst(
        canvas.width/2,
        canvas.height/2
      );

      // üëª ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏¢‡∏Å‡∏£‡πà‡∏≤‡∏á
      splitActive=true;
      splitTimer=80;

      setTimeout(()=>{
        effectCooldown=false;
      },2000);
    }
  }

  updateSmoke();
  drawSmoke();

});

// loop
function detectLoop(){
  const now=Date.now();
  if(now-lastProcessTime>PROCESS_INTERVAL){
    hands.send({image:video});
    lastProcessTime=now;
  }
  requestAnimationFrame(detectLoop);
}

video.addEventListener("loadeddata",()=>{
  detectLoop();
});

</script>

</body>
</html>

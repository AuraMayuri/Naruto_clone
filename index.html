<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Perfect Split</title>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js"></script>

<style>
body{margin:0;overflow:hidden;background:black;}
video,canvas{
  position:absolute;
  width:100vw;
  height:100vh;
  object-fit:cover;
}
</style>
</head>

<body>

<video id="video" autoplay playsinline></video>
<canvas id="canvas"></canvas>

<script>

const video=document.getElementById("video");
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");

canvas.width=window.innerWidth;
canvas.height=window.innerHeight;

let splitActive=false;
let smoke=[];
let cooldown=false;

// เปิดกล้อง
async function init(){
  const stream=await navigator.mediaDevices.getUserMedia({
    video:{width:640,height:480}
  });
  video.srcObject=stream;
}
init();

// โหลด segmentation
const segmenter=new SelfieSegmentation({
  locateFile:(file)=>{
    return `https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${file}`;
  }
});

segmenter.setOptions({ modelSelection:1 });

segmenter.onResults(results=>{

  ctx.clearRect(0,0,canvas.width,canvas.height);

  // ===== 1. วาดพื้นหลัง =====
  ctx.drawImage(video,0,0,canvas.width,canvas.height);

  if(splitActive){

    // ===== 2. สร้าง layer คนที่ถูกตัด =====
    ctx.save();

    // วาด mask ก่อน
    ctx.drawImage(results.segmentationMask,
      0,0,canvas.width,canvas.height);

    // ให้ video แสดงเฉพาะส่วนที่ mask ขาว
    ctx.globalCompositeOperation='source-in';

    // ===== 3. วาด 10 ร่าง =====
    for(let i=1;i<=5;i++){

      ctx.globalAlpha=0.4;
      ctx.drawImage(video,-35*i,0,
        canvas.width,canvas.height);

      ctx.drawImage(video,35*i,0,
        canvas.width,canvas.height);
    }

    ctx.globalAlpha=1;
    ctx.restore();
  }

  updateSmoke();
  drawSmoke();
});

// ===== ควันครั้งเดียว =====
function createSmoke(){
  for(let i=0;i<25;i++){
    smoke.push({
      x:canvas.width/2,
      y:canvas.height/2,
      size:20+Math.random()*30,
      alpha:1,
      vx:(Math.random()-0.5)*4,
      vy:(Math.random()-0.5)*4
    });
  }
}

function updateSmoke(){
  for(let i=smoke.length-1;i>=0;i--){
    let p=smoke[i];
    p.x+=p.vx;
    p.y+=p.vy;
    p.alpha-=0.03;
    if(p.alpha<=0) smoke.splice(i,1);
  }
}

function drawSmoke(){
  for(let p of smoke){
    ctx.beginPath();
    ctx.arc(p.x,p.y,p.size,0,Math.PI*2);
    ctx.fillStyle="rgba(200,200,200,"+p.alpha+")";
    ctx.fill();
  }
}

// ===== trigger แตะหน้าจอ =====
canvas.addEventListener("click",()=>{
  if(cooldown) return;

  cooldown=true;
  splitActive=true;
  createSmoke();

  setTimeout(()=>{
    splitActive=false;
  },1500);

  setTimeout(()=>{
    cooldown=false;
  },2000);
});

// loop
function loop(){
  segmenter.send({image:video});
  requestAnimationFrame(loop);
}

video.addEventListener("loadeddata",()=>{
  loop();
});

</script>

</body>
</html>

<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Real Freeze Split</title>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js"></script>

<style>
body{margin:0;overflow:hidden;background:black;}
video,canvas{
  position:absolute;
  width:100vw;
  height:100vh;
  object-fit:cover;
}
#log{
  position:absolute;
  top:10px;
  left:10px;
  color:#00ff88;
  background:rgba(0,0,0,0.5);
  padding:8px;
  font-size:14px;
}
</style>
</head>
<body>

<video id="video" autoplay playsinline></video>
<canvas id="canvas"></canvas>
<div id="log"></div>

<script>

const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const logDiv = document.getElementById("log");

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

let mode="idle";
let distanceLog=0;
let splitTimer=0;

let backgroundImage=null;
let personImage=null;

// เปิดกล้อง
navigator.mediaDevices.getUserMedia({video:true})
.then(stream=>video.srcObject=stream);

// ===== Hands =====
const hands = new Hands({
  locateFile:(file)=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
});
hands.setOptions({
  maxNumHands:2,
  modelComplexity:0,
  minDetectionConfidence:0.7,
  minTrackingConfidence:0.7
});

hands.onResults(res=>{

  if(mode==="idle"){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(video,0,0,canvas.width,canvas.height);
  }

  if(res.multiHandLandmarks){

    for(const landmarks of res.multiHandLandmarks){
      drawConnectors(ctx,landmarks,HAND_CONNECTIONS,
        {color:"#00FF00",lineWidth:3});
      drawLandmarks(ctx,landmarks,
        {color:"#FF0000",lineWidth:2});
    }

    if(res.multiHandLandmarks.length===2 && mode==="idle"){

      const h1=res.multiHandLandmarks[0][8];
      const h2=res.multiHandLandmarks[1][8];

      const dx=h1.x-h2.x;
      const dy=h1.y-h2.y;
      distanceLog=Math.sqrt(dx*dx+dy*dy);

      if(distanceLog<0.05){
        mode="capture";
        segmenter.send({image:video});
      }
    }
  }

  updateLog();
});

// ===== Segmentation =====
const segmenter = new SelfieSegmentation({
  locateFile:(file)=>`https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${file}`
});
segmenter.setOptions({modelSelection:1});

segmenter.onResults(results=>{

  if(mode!=="capture") return;

  // แคปพื้นหลัง
  backgroundImage=document.createElement("canvas");
  backgroundImage.width=canvas.width;
  backgroundImage.height=canvas.height;
  backgroundImage.getContext("2d")
    .drawImage(video,0,0,canvas.width,canvas.height);

  // แคปตัวคน
  const tempCanvas=document.createElement("canvas");
  tempCanvas.width=canvas.width;
  tempCanvas.height=canvas.height;
  const tctx=tempCanvas.getContext("2d");

  tctx.drawImage(results.segmentationMask,
    0,0,canvas.width,canvas.height);

  tctx.globalCompositeOperation="source-in";

  tctx.drawImage(video,0,0,
    canvas.width,canvas.height);

  personImage=tempCanvas;

  mode="split";
  splitTimer=120;
});

// ===== Split Loop =====
function drawSplit(){

  if(mode==="split" && personImage && backgroundImage){

    ctx.clearRect(0,0,canvas.width,canvas.height);

    // พื้นหลังนิ่ง
    ctx.drawImage(backgroundImage,0,0,
      canvas.width,canvas.height);

    // แยกร่าง 10
    for(let i=1;i<=5;i++){
      ctx.globalAlpha=0.4;
      ctx.drawImage(personImage,-40*i,0,
        canvas.width,canvas.height);
      ctx.drawImage(personImage,40*i,0,
        canvas.width,canvas.height);
    }

    ctx.globalAlpha=1;

    splitTimer--;
    if(splitTimer<=0){
      mode="idle";
      backgroundImage=null;
      personImage=null;
    }
  }

  requestAnimationFrame(drawSplit);
}
drawSplit();

function updateLog(){
  logDiv.innerHTML=
    "MODE: "+mode+"<br>"+
    "DISTANCE: "+distanceLog.toFixed(4)+"<br>"+
    "SPLIT TIMER: "+splitTimer;
}

// loop hands
function loop(){
  hands.send({image:video});
  requestAnimationFrame(loop);
}
video.addEventListener("loadeddata",loop);

</script>
</body>
</html>

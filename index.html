<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Clone Split</title>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.9.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix@2.2.0"></script>

<style>
body{margin:0;background:black;overflow:hidden;}
#log{
position:fixed;
top:0;
left:0;
color:#00ff88;
background:rgba(0,0,0,0.7);
font-size:12px;
padding:10px;
max-height:40vh;
overflow:auto;
font-family:monospace;
}
canvas{position:absolute;top:0;left:0;}
</style>
</head>
<body>

<video id="video" autoplay playsinline style="display:none"></video>
<canvas id="canvas"></canvas>
<div id="log"></div>

<script>
const video=document.getElementById("video");
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");
const logDiv=document.getElementById("log");

canvas.width=window.innerWidth;
canvas.height=window.innerHeight;

let bodyPixNet;
let mode="detect";
let freezeImage=null;
let personImage=null;
let splitProgress=0;

let splitDelay=800;
let splitSpeed=0.02;
let maxSpacing=90;
let maxBackSpacing=70;

let smokeParticles=[];
let smokePlayed=false;

async function init(){
  const stream=await navigator.mediaDevices.getUserMedia({video:true});
  video.srcObject=stream;

  bodyPixNet=await bodyPix.load();
  log("BodyPix loaded");

  const hands=new Hands({
    locateFile:(file)=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
  });

  hands.setOptions({
    maxNumHands:2,
    minDetectionConfidence:0.7,
    minTrackingConfidence:0.7
  });

  hands.onResults(onResults);

  const camera=new Camera(video,{
    onFrame:async()=>{
      await hands.send({image:video});
    },
    width:640,
    height:480
  });

  camera.start();
}

function log(msg){
  logDiv.innerHTML+=msg+"<br>";
  logDiv.scrollTop=logDiv.scrollHeight;
}

async function onResults(results){

  ctx.clearRect(0,0,canvas.width,canvas.height);

  if(mode==="detect"){
    ctx.drawImage(video,0,0,canvas.width,canvas.height);
  }

  if(results.multiHandLandmarks && mode==="detect"){

    const h1=results.multiHandLandmarks[0];
    const h2=results.multiHandLandmarks[1];

    if(h1 && h2){

      const p1=h1[8];
      const p2=h2[8];

      const dx=(p1.x-p2.x);
      const dy=(p1.y-p2.y);
      const distance=Math.sqrt(dx*dx+dy*dy);

      log("Distance: "+distance.toFixed(3));

      drawPoint(p1,"green");
      drawPoint(p2,"red");

      if(distance<0.05){
        log("✔ Detected");

        mode="smoke";

        freezeImage=ctx.getImageData(0,0,canvas.width,canvas.height);

        setTimeout(()=>{
          startSplit();
        },splitDelay);
      }
    }
  }

  if(mode==="smoke"){
    playSmoke();
  }

  if(mode==="split"){
    drawSplit();
  }
}

function drawPoint(p,color){
  ctx.fillStyle=color;
  ctx.beginPath();
  ctx.arc(p.x*canvas.width,p.y*canvas.height,8,0,Math.PI*2);
  ctx.fill();
}

function playSmoke(){

  if(!smokePlayed){
    for(let i=0;i<80;i++){
      smokeParticles.push({
        x:canvas.width/2,
        y:canvas.height/2,
        vx:(Math.random()-0.5)*4,
        vy:(Math.random()-0.5)*4,
        life:40
      });
    }
    smokePlayed=true;
    log("✔ Smoke 1 time");
  }

  ctx.putImageData(freezeImage,0,0);

  smokeParticles.forEach(p=>{
    ctx.fillStyle="rgba(200,200,200,"+(p.life/40)+")";
    ctx.beginPath();
    ctx.arc(p.x,p.y,20,0,Math.PI*2);
    ctx.fill();
    p.x+=p.vx;
    p.y+=p.vy;
    p.life--;
  });

  smokeParticles=smokeParticles.filter(p=>p.life>0);

  if(smokeParticles.length===0){
    log("✔ Smoke ended");
    mode="freeze";
    cutPerson();
  }
}

async function cutPerson(){
  const segmentation=await bodyPixNet.segmentPerson(video);
  const mask=bodyPix.toMask(segmentation);

  const temp=document.createElement("canvas");
  temp.width=canvas.width;
  temp.height=canvas.height;
  const tctx=temp.getContext("2d");

  tctx.drawImage(video,0,0,canvas.width,canvas.height);
  tctx.globalCompositeOperation="destination-in";
  tctx.drawImage(mask,0,0,canvas.width,canvas.height);

  personImage=temp;

  log("✔ Background removed");
}

function startSplit(){
  log("✔ Freeze + Split starting");
  mode="split";
}

function drawSplit(){

  ctx.putImageData(freezeImage,0,0);

  if(splitProgress<1){
    splitProgress+=splitSpeed;
  }

  const currentSpacing=maxSpacing*splitProgress;
  const currentBack=maxBackSpacing*splitProgress;

  log("Progress: "+splitProgress.toFixed(2));

  if(personImage){

    // หลัง 3
    for(let i=1;i<=3;i++){
      ctx.globalAlpha=0.4;
      ctx.drawImage(personImage,
        0,
        -currentBack*i,
        canvas.width,
        canvas.height
      );
    }

    // ซ้ายขวา 7
    for(let i=1;i<=7;i++){
      ctx.globalAlpha=0.8;
      ctx.drawImage(personImage,
        -currentSpacing*i,
        0,
        canvas.width,
        canvas.height
      );
      ctx.drawImage(personImage,
        currentSpacing*i,
        0,
        canvas.width,
        canvas.height
      );
    }

    ctx.globalAlpha=1;
  }
}

init();
</script>
</body>
</html>

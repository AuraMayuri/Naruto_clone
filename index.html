<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Ninja Clone Safari Fix</title>
<style>
body{margin:0;overflow:hidden;background:black;}
video{display:none;}
canvas{position:absolute;top:0;left:0;}
#startBtn{
  position:absolute;
  top:40%;
  left:50%;
  transform:translate(-50%,-50%);
  padding:20px 40px;
  font-size:22px;
  z-index:10;
}
</style>
</head>
<body>

<button id="startBtn">à¹€à¸£à¸´à¹ˆà¸¡à¸„à¸²à¸–à¸²</button>

<video id="video" playsinline muted></video>
<canvas id="canvas"></canvas>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const btn = document.getElementById("startBtn");

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

btn.onclick = async () => {

  btn.style.display="none";

  const stream = await navigator.mediaDevices.getUserMedia({
    video:{ facingMode:"user" }
  });

  video.srcObject = stream;

  await video.play();

  const hands = new Hands({
    locateFile: file =>
      `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
  });

  // ðŸ”¥ à¸›à¸´à¸” GPU à¹€à¸žà¸·à¹ˆà¸­à¸¥à¸”à¸›à¸±à¸à¸«à¸² iPad
  hands.setOptions({
    maxNumHands:2,
    modelComplexity:0,
    minDetectionConfidence:0.6,
    minTrackingConfidence:0.6
  });

  // hands.onResults(results=>{

  //   ctx.clearRect(0,0,canvas.width,canvas.height);

  //   ctx.drawImage(video,0,0,
  //     canvas.width,canvas.height);

  //   if(results.multiHandLandmarks){
  //     for(const landmarks of results.multiHandLandmarks){
  //       drawConnectors(ctx,landmarks,HAND_CONNECTIONS,
  //         {color:"lime",lineWidth:3});
  //       drawLandmarks(ctx,landmarks,
  //         {color:"red",lineWidth:2});
  //     }
  //   }
  // });
  let holdStart = 0;
let isCloning = false;
let clones = [];
  let debugText = "";

  
hands.onResults(results=>{

  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(video,0,0,canvas.width,canvas.height);

  // à¸§à¸²à¸”à¸£à¹ˆà¸²à¸‡à¸‹à¹‰à¸­à¸™à¸à¹ˆà¸­à¸™
  clones.forEach((img,i)=>{
    ctx.globalAlpha=0.5;
    ctx.drawImage(img,0,-60*(i+1),
      canvas.width,canvas.height);
  });
  ctx.globalAlpha=1;

  if(results.multiHandLandmarks &&
     results.multiHandLandmarks.length===2){

    const hand1 = results.multiHandLandmarks[0];
    const hand2 = results.multiHandLandmarks[1];

    const index1 = hand1[8];
    const index2 = hand2[8];

    const dx = index1.x - index2.x;
    const dy = index1.y - index2.y;
    const distance = Math.sqrt(dx*dx + dy*dy);

    // à¸§à¸²à¸”à¹€à¸ªà¹‰à¸™
    for(const landmarks of results.multiHandLandmarks){
      drawConnectors(ctx,landmarks,HAND_CONNECTIONS,
        {color:"lime",lineWidth:3});
      drawLandmarks(ctx,landmarks,
        {color:"red",lineWidth:2});
    }

    
    debugText = "distance: " + distance.toFixed(3);
    ctx.fillStyle="yellow";
    ctx.font="20px Arial";
    ctx.fillText(debugText,20,40);

    if(distance < 0.12){

      if(holdStart === 0){
        holdStart = Date.now();
      }

      if(Date.now() - holdStart > 800 && !isCloning){
        isCloning = true;
        createClone();
        setTimeout(()=>{ isCloning=false; },1500);
        holdStart = 0;
      }

    } else {
      holdStart = 0;
    }
  }
});

  function createClone(){

  const temp=document.createElement("canvas");
  temp.width=canvas.width;
  temp.height=canvas.height;
  const tctx=temp.getContext("2d");

  tctx.drawImage(video,0,0,
    canvas.width,canvas.height);

  clones.push(temp);

  // à¹€à¸­à¸Ÿà¹€à¸Ÿà¸„à¹à¸Ÿà¸¥à¸Š
  flash.style.opacity=1;
  setTimeout(()=>flash.style.opacity=0,150);

  // à¸„à¸§à¸±à¸™
  smoke.style.opacity=1;
  setTimeout(()=>smoke.style.opacity=0,400);

  // à¹€à¸ªà¸µà¸¢à¸‡
  const audio=new Audio(
    "https://actions.google.com/sounds/v1/cartoon/poof.ogg"
  );
  audio.play();
}
  
 

  async function detectLoop(){
    await hands.send({image:video});
    requestAnimationFrame(detectLoop);
  }

  detectLoop();
};
</script>

</body>
</html>

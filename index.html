<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Ninja Clone Full</title>
<style>
body{
  margin:0;
  overflow:hidden;
  background:black;
}
video{ display:none; }

canvas{
  position:absolute;
  top:0;
  left:0;
}

#startBtn{
  position:absolute;
  top:40%;
  left:50%;
  transform:translate(-50%,-50%);
  padding:20px 40px;
  font-size:22px;
  z-index:10;
}

#flash{
  position:absolute;
  width:100%;
  height:100%;
  background:white;
  opacity:0;
  pointer-events:none;
}

#smoke{
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  font-size:120px;
  opacity:0;
  pointer-events:none;
  transition:opacity 0.2s;
}
</style>
</head>
<body>

<button id="startBtn">à¹€à¸£à¸´à¹ˆà¸¡à¸„à¸²à¸–à¸²</button>

<div id="flash"></div>
<div id="smoke">ðŸ’¨</div>

<video id="video" playsinline></video>
<canvas id="canvas"></canvas>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const startBtn = document.getElementById("startBtn");
const flash = document.getElementById("flash");
const smoke = document.getElementById("smoke");

let clones=[];
let lastClone=0;

canvas.width=window.innerWidth;
canvas.height=window.innerHeight;

startBtn.onclick = async ()=>{

  startBtn.style.display="none";

  const stream = await navigator.mediaDevices.getUserMedia({
    video:{ facingMode:"user" }
  });

  video.srcObject=stream;

  await video.play();

  const hands = new Hands({
    locateFile: file =>
      `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
  });

  hands.setOptions({
    maxNumHands:2,
    minDetectionConfidence:0.7,
    minTrackingConfidence:0.7
  });

  hands.onResults(results=>{

    ctx.clearRect(0,0,canvas.width,canvas.height);

    ctx.drawImage(results.image,0,0,
      canvas.width,canvas.height);

    // à¸§à¸²à¸”à¸£à¹ˆà¸²à¸‡à¸‹à¹‰à¸­à¸™
    clones.forEach((img,i)=>{
      ctx.globalAlpha=0.5;
      ctx.drawImage(img,
        0,
        -80*(i+1),
        canvas.width,
        canvas.height
      );
    });

    ctx.globalAlpha=1;

    if(results.multiHandLandmarks){

      for(const landmarks of results.multiHandLandmarks){
        drawConnectors(ctx,landmarks,HAND_CONNECTIONS,
          {color:"lime",lineWidth:4});
        drawLandmarks(ctx,landmarks,
          {color:"red",lineWidth:2});
      }

      // à¸–à¹‰à¸²à¸¢à¸ 2 à¸¡à¸·à¸­
      if(results.multiHandLandmarks.length===2 &&
         Date.now()-lastClone>2000){

        createClone(results.image);
        lastClone=Date.now();
      }
    }
  });

  const camera = new Camera(video,{
    onFrame: async()=>{
      await hands.send({image:video});
    },
    width:640,
    height:480
  });

  camera.start();
};

function createClone(image){

  const temp=document.createElement("canvas");
  temp.width=canvas.width;
  temp.height=canvas.height;
  temp.getContext("2d").drawImage(
    image,0,0,canvas.width,canvas.height
  );

  clones.push(temp);

  // flash
  flash.style.opacity=1;
  setTimeout(()=>flash.style.opacity=0,150);

  // smoke
  smoke.style.opacity=1;
  setTimeout(()=>smoke.style.opacity=0,400);

  // sound
  const audio=new Audio(
    "https://actions.google.com/sounds/v1/cartoon/poof.ogg"
  );
  audio.play();
}
</script>

</body>
</html>
